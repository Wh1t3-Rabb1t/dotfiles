#!/usr/bin/env zsh

# ---------------------------------------------------------------------------- #
# Fzf zsh history and append selection to the command line.                    #
# ---------------------------------------------------------------------------- #
# Args    : None                                                               #
# Globals : BUFFER, CURSOR                                                     #
# ---------------------------------------------------------------------------- #

emulate -L zsh

# NOTE: The first awk line adds color to the second field (the commmand prefix).
# The second removes the command's index and cleans up white space before
# inserting the command onto the buffer.

# local selection
# local HEADER_A=" Command history. <Tab> : Switch to Fzf."
# local HEADER_B=" Command history. <Tab> : Switch to Rg."
# local PROMPT_A="Rg  "
# local PROMPT_B="Fzf  "

# # # Switch between Ripgrep mode and Fzf filtering mode with <Tab>
# # rm -f /tmp/rg-fzf-{r,f}
# # # RG_PREFIX="history 0 "
# # INITIAL_QUERY="${*:-}"

# RG_PREFIX="history 0 | rg ' '"
# rm -f /tmp/rg-fzf-{r,f}
# INITIAL_QUERY="${*:-}"

# selection=$( \
#     fzf --disabled --query "$INITIAL_QUERY" \
#         --no-preview \
#         --header=$HEADER_A \
#         --prompt=$PROMPT_A \
#         --bind="start:reload:$RG_PREFIX {q}" \
#         --bind="change:reload:sleep 0.1; $RG_PREFIX {q} || true" \
#         --bind='tab:transform:[[ ! $FZF_PROMPT =~ Rg ]] \
#             && echo \
#                 "rebind(change)+change-prompt('$PROMPT_A')+change-header('$HEADER_A')+disable-search+transform-query:echo \{q} \
#                     > /tmp/rg-fzf-f; cat /tmp/rg-fzf-r" \
#             || echo \
#                 "unbind(change)+change-prompt('$PROMPT_B')+change-header('$HEADER_B')+enable-search+transform-query:echo \{q} \
#                 > /tmp/rg-fzf-r; cat /tmp/rg-fzf-f"' \
#     | awk '{
#         $1="";
#         sub(/^ +/, "");
#         print
#     }' \
# )

# if [[ "$selection" ]]; then
#     BUFFER="$selection"
#     CURSOR=${#BUFFER}
#     zle redisplay
# fi





###########################################################
local selection=$( \
    history 0 \
    | awk '{
        $2="\033[38;5;35m"$2"\033[0m";
        print
    }' \
    | fzf \
        --header=' Command history.' \
        --no-preview \
    | awk '{
        $1="";
        sub(/^ +/, "");
        print
    }' \
)

if [[ "$selection" ]]; then
    BUFFER="$selection"
    CURSOR=${#BUFFER}
    zle redisplay
fi
